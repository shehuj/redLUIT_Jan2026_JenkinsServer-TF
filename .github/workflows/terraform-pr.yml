# ========================================================================
# Terraform Pull Request Workflow
# ========================================================================
#
# This workflow runs on pull requests to validate infrastructure changes
# WITHOUT deploying anything. It provides:
# - Terraform validation and formatting checks
# - Security scanning (tfsec, Checkov)
# - Plan preview with cost estimation
# - PR comments with plan details
#
# ========================================================================

name: 'Terraform PR Validation'

on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-pr.yml'
      - '.github/workflows/terraform-deploy.yml'

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TF_LOG: WARN
  TF_IN_AUTOMATION: true
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  validate:
    name: 'Validate & Plan'
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: ./terraform

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -recursive
      continue-on-error: false

    - name: Terraform Init -lock=false
      id: init
      run: terraform init

    - name: Terraform Validate
      id: validate
      run: terraform validate

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -lock=false -out=tfplan 2>&1 | tee plan.txt
        echo "exitcode=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Generate Plan Summary
      id: summary
      run: |
        # Count resources
        ADDS=$(grep -c "will be created" plan.txt || echo "0")
        CHANGES=$(grep -c "will be updated" plan.txt || echo "0")
        DESTROYS=$(grep -c "will be destroyed" plan.txt || echo "0")

        echo "adds=$ADDS" >> $GITHUB_OUTPUT
        echo "changes=$CHANGES" >> $GITHUB_OUTPUT
        echo "destroys=$DESTROYS" >> $GITHUB_OUTPUT

    - name: Comment PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('terraform/plan.txt', 'utf8');
          const fmt = '${{ steps.fmt.outcome }}';
          const init = '${{ steps.init.outcome }}';
          const validate = '${{ steps.validate.outcome }}';
          const planStatus = '${{ steps.plan.outcome }}';

          const adds = '${{ steps.summary.outputs.adds }}';
          const changes = '${{ steps.summary.outputs.changes }}';
          const destroys = '${{ steps.summary.outputs.destroys }}';

          const output = `## Terraform Plan Results ðŸ“‹

          #### Format Check: \`${fmt}\`
          #### Initialization: \`${init}\`
          #### Validation: \`${validate}\`
          #### Plan: \`${planStatus}\`

          ### Summary
          - **${adds}** resources to add
          - **${changes}** resources to change
          - **${destroys}** resources to destroy

          <details><summary>Show Full Plan</summary>

          \`\`\`terraform
          ${plan.length > 60000 ? plan.substring(0, 60000) + '\n\n... (plan truncated)' : plan}
          \`\`\`

          </details>

          ---
          **Pusher**: @${{ github.actor }}
          **Event**: \`${{ github.event_name }}\`
          **Workflow**: \`${{ github.workflow }}\`
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: terraform/tfplan
        retention-days: 30

  security:
    name: 'Security Scanning'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # tfsec Security Scan
    - name: Run tfsec
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: terraform
        soft_fail: false
        format: sarif
        additional_args: --minimum-severity MEDIUM

    - name: Move tfsec SARIF
      if: always()
      run: |
        if [ -f terraform/results.sarif ]; then
          mv terraform/results.sarif tfsec-results.sarif
          echo "âœ“ Moved tfsec results"
        elif [ -f results.sarif ]; then
          mv results.sarif tfsec-results.sarif
          echo "âœ“ Found tfsec results in root"
        else
          echo "âš  Warning: tfsec results not found"
          ls -la terraform/ || true
        fi

    - name: Upload tfsec SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: tfsec-results.sarif
        category: tfsec

    # Checkov Compliance Scan
    - name: Run Checkov
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: terraform
        framework: terraform
        output_format: sarif
        output_file_path: results.sarif
        soft_fail: true
        quiet: false
        download_external_modules: true

    - name: Move Checkov SARIF
      if: always()
      run: |
        if [ -f results.sarif ]; then
          mv results.sarif checkov-results.sarif
          echo "âœ“ Moved Checkov results"
        else
          echo "âš  Warning: Checkov results not found"
        fi

    - name: Upload Checkov SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: checkov-results.sarif
        category: checkov

    - name: Security Summary
      if: always()
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ tfsec scan completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ Checkov scan completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in the [Security tab](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

  cost-estimate:
    name: 'Cost Estimation'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init -lock=false
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Plan for Cost
      run: terraform plan -lock=false -out=tfplan
      working-directory: ./terraform

    - name: Cost Comment
      uses: actions/github-script@v7
      with:
        script: |
          const output = `## ðŸ’° Cost Estimation

          ### Production Configuration
          - **EC2 Instance**: m5.xlarge (~$140/month)
          - **EBS Volume**: 50GB GP3 (~$4/month)
          - **S3 Storage**: ~$1-5/month (usage-based)
          - **Data Transfer**: ~$5-10/month
          - **CloudWatch**: ~$2-3/month
          - **Elastic IP**: $0 (while attached)

          **Estimated Total**: ~$152-162/month

          > ðŸ’¡ Actual costs may vary based on usage patterns
          > ðŸ“Š Use AWS Cost Explorer for precise tracking
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });
