name: Terraform PR Validation

on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'terraform/**'
      - 'ansible/**'
      - '.github/workflows/terraform-pr.yml'
      - '.github/workflows/terraform-deploy.yml'

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TF_LOG: WARN
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TF_IN_AUTOMATION: true
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  validate:
    name: 'Validate & Plan'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        id: fmt
        working-directory: ./terraform
        run: terraform fmt -recursive

      - name: Terraform Init
        id: init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        id: validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ./terraform
        run: |
          set -o pipefail
          terraform plan -lock=false -out=tfplan 2>&1 | tee plan.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate Plan Summary
        id: summary
        working-directory: ./terraform
        run: |
          ADDS=$(grep -c "will be created" plan.txt || echo "0")
          CHANGES=$(grep -c "will be updated" plan.txt || echo "0")
          DESTROYS=$(grep -c "will be destroyed" plan.txt || echo "0")

          echo "adds=${ADDS}" >> $GITHUB_OUTPUT
          echo "changes=${CHANGES}" >> $GITHUB_OUTPUT
          echo "destroys=${DESTROYS}" >> $GITHUB_OUTPUT

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // read the terraform plan output
            const planTxt = fs.readFileSync('terraform/plan.txt', 'utf8');

            const fmt = '${{ steps.fmt.outcome }}';
            const init = '${{ steps.init.outcome }}';
            const validate = '${{ steps.validate.outcome }}';
            const planStatus = '${{ steps.plan.outcome }}';

            const adds = '${{ steps.summary.outputs.adds }}';
            const changes = '${{ steps.summary.outputs.changes }}';
            const destroys = '${{ steps.summary.outputs.destroys }}';

            const body = `## Terraform Plan Results ðŸ“‹

### Status
- **Format Check:** \`${fmt}\`
- **Init:** \`${init}\`
- **Validate:** \`${validate}\`
- **Plan:** \`${planStatus}\`

### Summary
- **${adds}** to create
- **${changes}** to update
- **${destroys}** to destroy

<details><summary>Show Terraform Plan</summary>

\`\`\`terraform
${planTxt.length > 60000 ? planTxt.substring(0, 60000) + '\n\n... (plan truncated)' : planTxt}
\`\`\`

</details>

---
**Triggered by:** @${{ github.actor }}
`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 30

  security:
    name: 'Security Scanning'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: false
          format: sarif
          additional_args: --minimum-severity MEDIUM

      - name: Upload tfsec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: tfsec-results.sarif
          category: tfsec

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
          quiet: false
          download_external_modules: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: checkov-results.sarif
          category: checkov

  cost-estimate:
    name: 'Cost Estimation'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init for Cost
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Plan for Cost
        working-directory: ./terraform
        run: terraform plan -lock=false -out=tfplan

      - name: Cost Comment
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## ðŸ’° Estimated Costs

- Plan calculates approximate costs (depends on config)
- EC2 instance, S3 storage, networking, etc.

> Actual values vary by usage and region
`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });