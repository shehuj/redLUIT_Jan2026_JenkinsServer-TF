name: Terraform Deploy

on:
  push:
    branches: [ "main" ]
    paths:
      - 'terraform/**'
      - 'ansible/**'
      - '.github/workflows/terraform-deploy.yml'

permissions:
  contents: read
  id-token: write

env:
  TF_LOG: WARN
  TF_IN_AUTOMATION: true
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  deploy:
    name: 'Deploy Infrastructure'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        id: fmt
        working-directory: ./terraform
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        id: validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ./terraform
        run: |
          terraform plan -out=tfplan 2>&1 | tee plan.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: terraform/tfplan
          retention-days: 7

      - name: Terraform Apply
        id: apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      # Extract Terraform outputs
      - name: Get Jenkins IP Address
        id: tf_outputs
        working-directory: ./terraform
        run: |
          JENKINS_IP=$(terraform output -raw jenkins_public_ip)
          echo "jenkins_ip=${JENKINS_IP}" >> $GITHUB_OUTPUT
          echo "Jenkins IP Address: ${JENKINS_IP}"

      # Wait for EC2 to be ready
      - name: Wait for SSH to be available
        run: |
          echo "Waiting for SSH on ${{ steps.tf_outputs.outputs.jenkins_ip }}..."
          for i in {1..60}; do
            if nc -z ${{ steps.tf_outputs.outputs.jenkins_ip }} 22 2>/dev/null; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Attempt $i: SSH not ready, waiting 5 seconds..."
            sleep 5
          done
          echo "ERROR: SSH did not become available"
          exit 1

      # Setup Ansible
      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible boto3 botocore

      # Setup SSH key for Ansible
      - name: Configure SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

          # Check and convert key format if needed
          if head -n 1 ~/.ssh/key.pem | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
            echo "Converting OpenSSH format to RSA format..."
            ssh-keygen -p -N "" -m pem -f ~/.ssh/key.pem
          fi

          # Verify key format
          echo "Key format:"
          head -n 1 ~/.ssh/key.pem

          # Add host key to known_hosts
          ssh-keyscan -H ${{ steps.tf_outputs.outputs.jenkins_ip }} >> ~/.ssh/known_hosts

          # Start ssh-agent and add key
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/key.pem

      # Test SSH connection
      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to ${{ steps.tf_outputs.outputs.jenkins_ip }}..."
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
            'echo "SSH connection successful! Ubuntu version: $(lsb_release -d | cut -f2)"'

      # Wait for user-data script to complete
      - name: Wait for EC2 initialization
        run: |
          echo "Waiting for user-data script to complete on ${{ steps.tf_outputs.outputs.jenkins_ip }}..."
          for i in {1..60}; do
            if ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
              'test -f /var/log/user-data-complete' 2>/dev/null; then
              echo "âœ… User-data script completed!"
              ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
                'cat /var/log/user-data-complete'
              exit 0
            fi
            echo "Attempt $i/60: Initialization in progress, waiting 10 seconds..."
            sleep 10
          done
          echo "âš ï¸ WARNING: User-data script did not complete in time (10 minutes), proceeding anyway..."
          echo "Last 20 lines of user-data log:"
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
            'tail -20 /var/log/user-data.log' || echo "Could not retrieve user-data log"

      # Create Ansible inventory
      - name: Create Ansible Inventory
        working-directory: ./ansible
        run: |
          mkdir -p inventory
          cat > inventory/jenkins_hosts.ini <<EOF
          [jenkins]
          ${{ steps.tf_outputs.outputs.jenkins_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=$HOME/.ssh/key.pem

          [jenkins:vars]
          ansible_python_interpreter=/usr/bin/python3
          EOF
          cat inventory/jenkins_hosts.ini

      # Test Ansible connectivity
      - name: Test Ansible Connection
        working-directory: ./ansible
        run: |
          echo "Testing Ansible connectivity..."
          ansible -i inventory/jenkins_hosts.ini jenkins -m ping -v

      # Run Ansible playbook
      - name: Deploy Jenkins with Ansible
        id: ansible
        working-directory: ./ansible
        run: |
          ansible-playbook \
            -i inventory/jenkins_hosts.ini \
            playbooks/deploy_jenkins.yml \
            -v

      # Retrieve Jenkins password
      - name: Get Jenkins Initial Password
        id: jenkins_password
        run: |
          PASSWORD=$(ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
            'sudo cat /var/lib/jenkins/secrets/initialAdminPassword' 2>/dev/null || echo "PASSWORD_RETRIEVAL_FAILED")
          echo "password=${PASSWORD}" >> $GITHUB_OUTPUT

      # Update deployment summary
      - name: Generate Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Jenkins Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Format:** \`${{ steps.fmt.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Init:** \`${{ steps.init.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Validate:** \`${{ steps.validate.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Plan:** \`${{ steps.plan.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Apply:** \`${{ steps.apply.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Ansible Deployment:** \`${{ steps.ansible.outcome }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Jenkins Access Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jenkins URL:** http://${{ steps.tf_outputs.outputs.jenkins_ip }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Username:** \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Initial Admin Password:** \`${{ steps.jenkins_password.outputs.password }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY