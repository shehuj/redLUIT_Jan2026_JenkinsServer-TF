name: Terraform Destroy - Resource Cleanup

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Workspace to destroy (dev/prod)'
        required: true
        type: choice
        options:
          - dev
          - prod
      confirmation:
        description: 'Type "DESTROY" to confirm resource deletion'
        required: true
        type: string
      reason:
        description: 'Reason for destroying infrastructure'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  TF_LOG: WARN
  TF_IN_AUTOMATION: true
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  validate-input:
    name: 'Validate Confirmation'
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
      workspace: ${{ steps.check.outputs.workspace }}

    steps:
      - name: Validate Destroy Confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ Invalid confirmation. You must type exactly 'DESTROY' to proceed."
            echo "You entered: ${{ github.event.inputs.confirmation }}"
            exit 1
          fi
          echo "âœ… Confirmation validated"
          echo "proceed=true" >> $GITHUB_OUTPUT
          echo "workspace=${{ github.event.inputs.workspace }}" >> $GITHUB_OUTPUT

      - name: Log Destruction Request
        run: |
          echo "## ðŸš¨ DESTRUCTION REQUEST LOGGED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workspace:** ${{ github.event.inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Proceeding with infrastructure destruction..." >> $GITHUB_STEP_SUMMARY

  pre-destroy-inventory:
    name: 'Pre-Destroy Inventory'
    runs-on: ubuntu-latest
    needs: validate-input

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        working-directory: ./infra/terraform
        run: |
          WORKSPACE="${{ needs.validate-input.outputs.workspace }}"

          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}" \
            -backend-config="key=terraform-states/${WORKSPACE}/infra.tfstate"

          # Idempotent workspace selection
          if terraform workspace list | grep -q "\b${WORKSPACE}\b"; then
            echo "Selecting workspace: ${WORKSPACE}"
            terraform workspace select ${WORKSPACE}
          else
            echo "âš ï¸ Warning: Workspace ${WORKSPACE} does not exist - may be already destroyed"
            echo "## âš ï¸ Workspace Not Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The workspace **${WORKSPACE}** does not exist in the backend." >> $GITHUB_STEP_SUMMARY
            echo "This might mean the infrastructure was already destroyed or never created." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

      - name: Show Current Resources in State
        id: show
        working-directory: ./infra/terraform
        run: |
          echo "## ðŸ“‹ Current Terraform State Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to view Terraform state</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          terraform show -no-color 2>&1 | head -200 >> $GITHUB_STEP_SUMMARY || echo "No state found or error reading state" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: List AWS Resources
        run: |
          echo "## ðŸ” AWS Resources to be Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get environment-specific tag
          ENV_TAG="${{ needs.validate-input.outputs.workspace }}"

          # List EC2 instances
          echo "### EC2 Instances" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-instances \
            --filters "Name=tag:ManagedBy,Values=Terraform" "Name=instance-state-name,Values=running,stopped,pending,stopping" \
            --query 'Reservations[*].Instances[*].[InstanceId,PublicIpAddress,PrivateIpAddress,State.Name,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No EC2 instances found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List VPCs
          echo "### VPCs" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-vpcs \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Vpcs[*].[VpcId,CidrBlock,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No VPCs found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List Subnets
          echo "### Subnets" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-subnets \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Subnets[*].[SubnetId,VpcId,CidrBlock,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No subnets found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List Security Groups
          echo "### Security Groups" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-security-groups \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'SecurityGroups[*].[GroupId,GroupName,VpcId]' \
            --output table >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No security groups found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List EBS Volumes
          echo "### EBS Volumes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-volumes \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Volumes[*].[VolumeId,State,Size,Tags[?Key==`Name`].Value|[0]]' \
            --output table >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No EBS volumes found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: 'Destroy Infrastructure'
    runs-on: ubuntu-latest
    needs: [validate-input, pre-destroy-inventory]
    # Add environment protection for production
    environment: ${{ github.event.inputs.workspace == 'prod' && 'production' || 'development' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        working-directory: ./infra/terraform
        run: |
          WORKSPACE="${{ needs.validate-input.outputs.workspace }}"

          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}" \
            -backend-config="key=terraform-states/${WORKSPACE}/infra.tfstate"

          # Select workspace
          if terraform workspace list | grep -q "\b${WORKSPACE}\b"; then
            echo "Selecting workspace: ${WORKSPACE}"
            terraform workspace select ${WORKSPACE}
          else
            echo "âš ï¸ Workspace ${WORKSPACE} does not exist - nothing to destroy"
            exit 0
          fi

          echo "TF_WORKSPACE=${WORKSPACE}" >> $GITHUB_ENV

      - name: Terraform Destroy Plan
        id: plan
        working-directory: ./infra/terraform
        run: |
          terraform plan -destroy -out=destroy.tfplan 2>&1 | tee destroy_plan.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Show Destroy Plan Summary
        working-directory: ./infra/terraform
        run: |
          echo "## ðŸ—‘ï¸ Terraform Destroy Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to view destroy plan</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          cat destroy_plan.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload Destroy Plan
        uses: actions/upload-artifact@v4
        with:
          name: destroy-plan-${{ github.event.inputs.workspace }}-${{ github.sha }}
          path: infra/terraform/destroy.tfplan
          retention-days: 7

      - name: Terraform Destroy
        id: destroy
        working-directory: ./infra/terraform
        run: |
          echo "Starting Terraform destroy for workspace: $TF_WORKSPACE..."
          terraform destroy -auto-approve 2>&1 | tee destroy_output.txt
          DESTROY_EXIT_CODE=${PIPESTATUS[0]}

          echo "Terraform destroy completed with exit code: $DESTROY_EXIT_CODE"
          echo "exitcode=$DESTROY_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $DESTROY_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ Terraform destroy encountered errors"
            echo "Proceeding with orphaned resource cleanup..."
          fi

          exit $DESTROY_EXIT_CODE

      - name: Verify Core Resources Destroyed
        id: verify_core
        if: always()
        run: |
          echo "## ðŸ” Post-Destroy Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ISSUES_FOUND=0

          # Check for remaining EC2 instances
          echo "### EC2 Instances" >> $GITHUB_STEP_SUMMARY
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:ManagedBy,Values=Terraform" "Name=instance-state-name,Values=running,stopped,stopping,pending" \
            --query 'Reservations[*].Instances[*].InstanceId' \
            --output text)

          if [ -z "$INSTANCES" ]; then
            echo "âœ… No EC2 instances remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining instances: $INSTANCES" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining VPCs
          echo "### VPCs" >> $GITHUB_STEP_SUMMARY
          VPCS=$(aws ec2 describe-vpcs \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Vpcs[*].VpcId' \
            --output text)

          if [ -z "$VPCS" ]; then
            echo "âœ… No VPCs remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining VPCs: $VPCS" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining Security Groups
          echo "### Security Groups" >> $GITHUB_STEP_SUMMARY
          SGS=$(aws ec2 describe-security-groups \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'SecurityGroups[*].GroupId' \
            --output text)

          if [ -z "$SGS" ]; then
            echo "âœ… No security groups remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining security groups: $SGS" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining Subnets
          echo "### Subnets" >> $GITHUB_STEP_SUMMARY
          SUBNETS=$(aws ec2 describe-subnets \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Subnets[*].SubnetId' \
            --output text)

          if [ -z "$SUBNETS" ]; then
            echo "âœ… No subnets remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining subnets: $SUBNETS" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining Internet Gateways
          echo "### Internet Gateways" >> $GITHUB_STEP_SUMMARY
          IGWS=$(aws ec2 describe-internet-gateways \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'InternetGateways[*].InternetGatewayId' \
            --output text)

          if [ -z "$IGWS" ]; then
            echo "âœ… No internet gateways remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining internet gateways: $IGWS" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining Route Tables
          echo "### Route Tables" >> $GITHUB_STEP_SUMMARY
          RTS=$(aws ec2 describe-route-tables \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'RouteTables[*].RouteTableId' \
            --output text)

          if [ -z "$RTS" ]; then
            echo "âœ… No route tables remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining route tables: $RTS" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining EBS Volumes
          echo "### EBS Volumes" >> $GITHUB_STEP_SUMMARY
          VOLS=$(aws ec2 describe-volumes \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Volumes[*].VolumeId' \
            --output text)

          if [ -z "$VOLS" ]; then
            echo "âœ… No EBS volumes remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found remaining volumes: $VOLS" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "issues_found=$ISSUES_FOUND" >> $GITHUB_OUTPUT

      - name: Generate Final Summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workspace:** ${{ needs.validate-input.outputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.destroy.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.destroy.outcome }}" == "success" ] && [ "${{ steps.verify_core.outputs.issues_found }}" == "0" ]; then
            echo "### âœ… Infrastructure Successfully Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All Terraform-managed resources have been removed from AWS." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.destroy.outcome }}" == "success" ] && [ "${{ steps.verify_core.outputs.issues_found }}" != "0" ]; then
            echo "### âš ï¸ Destruction Completed with Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Terraform destroy completed, but some resources remain." >> $GITHUB_STEP_SUMMARY
            echo "The orphaned resource cleanup job will attempt to remove them." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Destruction Failed or Incomplete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some resources may not have been destroyed. Please review the logs." >> $GITHUB_STEP_SUMMARY
            echo "The orphaned resource cleanup job will attempt to clean up remaining resources." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

  cleanup-orphaned-resources:
    name: 'Cleanup Orphaned Resources'
    runs-on: ubuntu-latest
    needs: [validate-input, destroy]
    if: always()

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Find and Clean Orphaned Resources
        run: |
          echo "## ðŸ§¹ Orphaned Resources Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Attempting to clean up any resources Terraform couldn't delete..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up orphaned network interfaces
          echo "### Network Interfaces" >> $GITHUB_STEP_SUMMARY
          ENI_COUNT=0
          aws ec2 describe-network-interfaces \
            --filters "Name=tag:ManagedBy,Values=Terraform" "Name=status,Values=available" \
            --query 'NetworkInterfaces[*].NetworkInterfaceId' \
            --output text | while read -r eni; do
              if [ ! -z "$eni" ]; then
                echo "Deleting orphaned ENI: $eni" >> $GITHUB_STEP_SUMMARY
                aws ec2 delete-network-interface --network-interface-id $eni 2>&1 || echo "Failed to delete $eni" >> $GITHUB_STEP_SUMMARY
                ENI_COUNT=$((ENI_COUNT + 1))
              fi
          done || true
          echo "Deleted $ENI_COUNT network interfaces" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up orphaned security groups (retry logic for dependencies)
          echo "### Security Groups" >> $GITHUB_STEP_SUMMARY
          SG_COUNT=0
          for attempt in 1 2 3; do
            echo "Attempt $attempt to delete security groups..." >> $GITHUB_STEP_SUMMARY
            aws ec2 describe-security-groups \
              --filters "Name=tag:ManagedBy,Values=Terraform" \
              --query 'SecurityGroups[?GroupName!=`default`].GroupId' \
              --output text | while read -r sg_id; do
                if [ ! -z "$sg_id" ]; then
                  echo "Attempting to delete security group: $sg_id" >> $GITHUB_STEP_SUMMARY
                  if aws ec2 delete-security-group --group-id $sg_id 2>&1; then
                    echo "âœ… Deleted $sg_id" >> $GITHUB_STEP_SUMMARY
                    SG_COUNT=$((SG_COUNT + 1))
                  else
                    echo "âš ï¸ Could not delete $sg_id (may have dependencies)" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
            done || true
            sleep 5
          done
          echo "Deleted $SG_COUNT security groups" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up internet gateways
          echo "### Internet Gateways" >> $GITHUB_STEP_SUMMARY
          IGW_COUNT=0
          aws ec2 describe-internet-gateways \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'InternetGateways[*].[InternetGatewayId,Attachments[0].VpcId]' \
            --output text | while read -r igw_id vpc_id; do
              if [ ! -z "$igw_id" ]; then
                echo "Detaching and deleting IGW: $igw_id from VPC: $vpc_id" >> $GITHUB_STEP_SUMMARY
                if [ ! -z "$vpc_id" ]; then
                  aws ec2 detach-internet-gateway --internet-gateway-id $igw_id --vpc-id $vpc_id 2>&1 || echo "Failed to detach $igw_id" >> $GITHUB_STEP_SUMMARY
                fi
                aws ec2 delete-internet-gateway --internet-gateway-id $igw_id 2>&1 || echo "Failed to delete $igw_id" >> $GITHUB_STEP_SUMMARY
                IGW_COUNT=$((IGW_COUNT + 1))
              fi
          done || true
          echo "Processed $IGW_COUNT internet gateways" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up subnets
          echo "### Subnets" >> $GITHUB_STEP_SUMMARY
          SUBNET_COUNT=0
          aws ec2 describe-subnets \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Subnets[*].SubnetId' \
            --output text | while read -r subnet_id; do
              if [ ! -z "$subnet_id" ]; then
                echo "Deleting subnet: $subnet_id" >> $GITHUB_STEP_SUMMARY
                aws ec2 delete-subnet --subnet-id $subnet_id 2>&1 || echo "Failed to delete $subnet_id" >> $GITHUB_STEP_SUMMARY
                SUBNET_COUNT=$((SUBNET_COUNT + 1))
              fi
          done || true
          echo "Deleted $SUBNET_COUNT subnets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up route tables
          echo "### Route Tables" >> $GITHUB_STEP_SUMMARY
          RT_COUNT=0
          aws ec2 describe-route-tables \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'RouteTables[?Associations[0].Main!=`true`].RouteTableId' \
            --output text | while read -r rt_id; do
              if [ ! -z "$rt_id" ]; then
                echo "Deleting route table: $rt_id" >> $GITHUB_STEP_SUMMARY
                aws ec2 delete-route-table --route-table-id $rt_id 2>&1 || echo "Failed to delete $rt_id" >> $GITHUB_STEP_SUMMARY
                RT_COUNT=$((RT_COUNT + 1))
              fi
          done || true
          echo "Deleted $RT_COUNT route tables" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up VPCs
          echo "### VPCs" >> $GITHUB_STEP_SUMMARY
          VPC_COUNT=0
          aws ec2 describe-vpcs \
            --filters "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Vpcs[*].VpcId' \
            --output text | while read -r vpc_id; do
              if [ ! -z "$vpc_id" ]; then
                echo "Deleting VPC: $vpc_id" >> $GITHUB_STEP_SUMMARY
                aws ec2 delete-vpc --vpc-id $vpc_id 2>&1 || echo "Failed to delete $vpc_id (may have dependencies)" >> $GITHUB_STEP_SUMMARY
                VPC_COUNT=$((VPC_COUNT + 1))
              fi
          done || true
          echo "Attempted to delete $VPC_COUNT VPCs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Clean up orphaned EBS volumes
          echo "### EBS Volumes" >> $GITHUB_STEP_SUMMARY
          VOL_COUNT=0
          aws ec2 describe-volumes \
            --filters "Name=status,Values=available" "Name=tag:ManagedBy,Values=Terraform" \
            --query 'Volumes[*].VolumeId' \
            --output text | while read -r vol; do
              if [ ! -z "$vol" ]; then
                echo "Deleting orphaned volume: $vol" >> $GITHUB_STEP_SUMMARY
                aws ec2 delete-volume --volume-id $vol 2>&1 || echo "Failed to delete $vol" >> $GITHUB_STEP_SUMMARY
                VOL_COUNT=$((VOL_COUNT + 1))
              fi
          done || true
          echo "Deleted $VOL_COUNT EBS volumes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Orphaned resources cleanup completed" >> $GITHUB_STEP_SUMMARY

  final-verification:
    name: 'Final Cleanup Verification'
    runs-on: ubuntu-latest
    needs: [validate-input, cleanup-orphaned-resources]
    if: always()

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Final Resource Check
        run: |
          echo "## ðŸŽ¯ Final Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for any remaining Terraform-managed resources..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ALL_CLEAN=true

          # Check all resource types
          INSTANCES=$(aws ec2 describe-instances --filters "Name=tag:ManagedBy,Values=Terraform" "Name=instance-state-name,Values=running,stopped,stopping,pending" --query 'Reservations[*].Instances[*].InstanceId' --output text)
          VPCS=$(aws ec2 describe-vpcs --filters "Name=tag:ManagedBy,Values=Terraform" --query 'Vpcs[*].VpcId' --output text)
          SGS=$(aws ec2 describe-security-groups --filters "Name=tag:ManagedBy,Values=Terraform" --query 'SecurityGroups[*].GroupId' --output text)
          SUBNETS=$(aws ec2 describe-subnets --filters "Name=tag:ManagedBy,Values=Terraform" --query 'Subnets[*].SubnetId' --output text)
          IGWS=$(aws ec2 describe-internet-gateways --filters "Name=tag:ManagedBy,Values=Terraform" --query 'InternetGateways[*].InternetGatewayId' --output text)
          RTS=$(aws ec2 describe-route-tables --filters "Name=tag:ManagedBy,Values=Terraform" --query 'RouteTables[*].RouteTableId' --output text)
          VOLS=$(aws ec2 describe-volumes --filters "Name=tag:ManagedBy,Values=Terraform" --query 'Volumes[*].VolumeId' --output text)

          if [ ! -z "$INSTANCES" ]; then
            echo "âš ï¸ **EC2 Instances still exist:** $INSTANCES" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          if [ ! -z "$VPCS" ]; then
            echo "âš ï¸ **VPCs still exist:** $VPCS" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          if [ ! -z "$SGS" ]; then
            echo "âš ï¸ **Security Groups still exist:** $SGS" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          if [ ! -z "$SUBNETS" ]; then
            echo "âš ï¸ **Subnets still exist:** $SUBNETS" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          if [ ! -z "$IGWS" ]; then
            echo "âš ï¸ **Internet Gateways still exist:** $IGWS" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          if [ ! -z "$RTS" ]; then
            echo "âš ï¸ **Route Tables still exist:** $RTS" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          if [ ! -z "$VOLS" ]; then
            echo "âš ï¸ **EBS Volumes still exist:** $VOLS" >> $GITHUB_STEP_SUMMARY
            ALL_CLEAN=false
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ALL_CLEAN" = true ]; then
            echo "### âœ… All Resources Successfully Cleaned Up" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Terraform-managed resources remain in AWS for workspace **${{ needs.validate-input.outputs.workspace }}**." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some Resources Still Remain" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some resources could not be automatically deleted." >> $GITHUB_STEP_SUMMARY
            echo "This may be due to:" >> $GITHUB_STEP_SUMMARY
            echo "- AWS resource dependencies" >> $GITHUB_STEP_SUMMARY
            echo "- Resources created outside of Terraform" >> $GITHUB_STEP_SUMMARY
            echo "- Resources with deletion protection enabled" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please manually review and delete these resources in the AWS console." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Additional Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform state file remains in S3 backend" >> $GITHUB_STEP_SUMMARY
          echo "- To completely remove the workspace, delete: \`terraform-states/${{ needs.validate-input.outputs.workspace }}/infra.tfstate\`" >> $GITHUB_STEP_SUMMARY
          echo "- Backend infrastructure (S3 bucket, DynamoDB table) is NOT destroyed" >> $GITHUB_STEP_SUMMARY
