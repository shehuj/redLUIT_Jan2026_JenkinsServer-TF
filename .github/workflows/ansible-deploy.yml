name: Ansible Configuration

on:

  push:
    branches: [ "main" ]
    paths:
      - 'ansible/**'
      - 'infra/terraform/**'
      - '.github/workflows/ansible-deploy.yml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  # ============================================================================
  # Job 1: Check Infrastructure (Runs on PRs)
  # ============================================================================
  check-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Validation Start
        run: |
          echo "## ðŸ” Infrastructure Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: Pre-deployment validation for PR" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - name: Set Terraform Workspace
        id: workspace
        run: |
          # For PRs, always use dev workspace
          echo "workspace=dev" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: |
          WORKSPACE="${{ steps.workspace.outputs.workspace }}"

          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}" \
            -backend-config="key=terraform-states/${WORKSPACE}/infra.tfstate"

          if ! terraform workspace list | grep -q "\b${WORKSPACE}\b"; then
            echo "Creating workspace: ${WORKSPACE}"
            terraform workspace new ${WORKSPACE}
          else
            echo "Selecting workspace: ${WORKSPACE}"
            terraform workspace select ${WORKSPACE}
          fi

          echo "TF_WORKSPACE=${WORKSPACE}" >> $GITHUB_ENV

      - name: Validate Infrastructure Outputs
        id: validate
        working-directory: ./infra/terraform
        run: |
          echo "ðŸ” Checking Terraform outputs..."

          # Check if outputs exist
          if ! terraform output -json 2>&1 | grep -q '"jenkins_public_ip"'; then
            echo "âŒ No Terraform outputs found"
            echo "Infrastructure must be deployed first. Run Terraform Deploy workflow."
            exit 1
          fi

          # Retrieve IPs
          JENKINS_PUBLIC_IP=$(terraform output -raw jenkins_public_ip 2>&1)
          JENKINS_PRIVATE_IP=$(terraform output -raw jenkins_private_ip 2>&1)
          JENKINS_INSTANCE_ID=$(terraform output -raw jenkins_instance_id 2>&1)

          # Validate formats
          if [[ ! "${JENKINS_PUBLIC_IP}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid public IP: ${JENKINS_PUBLIC_IP}"
            exit 1
          fi

          if [[ ! "${JENKINS_PRIVATE_IP}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid private IP: ${JENKINS_PRIVATE_IP}"
            exit 1
          fi

          if [[ ! "${JENKINS_INSTANCE_ID}" =~ ^i-[a-f0-9]+$ ]]; then
            echo "âŒ Invalid instance ID: ${JENKINS_INSTANCE_ID}"
            exit 1
          fi

          echo "jenkins_public_ip=${JENKINS_PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "jenkins_private_ip=${JENKINS_PRIVATE_IP}" >> $GITHUB_OUTPUT
          echo "jenkins_instance_id=${JENKINS_INSTANCE_ID}" >> $GITHUB_OUTPUT

          echo "âœ… Public IP: ${JENKINS_PUBLIC_IP}"
          echo "âœ… Private IP: ${JENKINS_PRIVATE_IP}"
          echo "âœ… Instance ID: ${JENKINS_INSTANCE_ID}"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible boto3 botocore

      - name: Configure SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_KEY" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

      - name: Wait for EC2 SSH Availability
        run: |
          echo "â³ Waiting for EC2 instance to accept SSH connections..."
          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/key.pem ubuntu@${{ steps.validate.outputs.jenkins_public_ip }} "echo 'SSH OK'" 2>/dev/null; then
              echo "âœ… EC2 instance is accessible via SSH"
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Waiting 10 seconds..."
            sleep 10
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âŒ EC2 instance did not become accessible"
            exit 1
          fi

      - name: Test Ansible Connectivity
        run: |
          echo "[jenkins]" > /tmp/hosts.ini
          echo "jenkins_server ansible_host=${{ steps.validate.outputs.jenkins_public_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/key.pem" >> /tmp/hosts.ini
          echo "" >> /tmp/hosts.ini
          echo "[jenkins:vars]" >> /tmp/hosts.ini
          echo "ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> /tmp/hosts.ini

          echo "ðŸ” Testing Ansible connectivity..."
          ansible -i /tmp/hosts.ini jenkins -m ping -v

      - name: Validation Summary
        run: |
          echo "## âœ… Infrastructure Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Validated Components" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform state accessible" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EC2 instance provisioned" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Public IP: ${{ steps.validate.outputs.jenkins_public_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Private IP: ${{ steps.validate.outputs.jenkins_private_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SSH connectivity working" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ansible can connect to instance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ Note" >> $GITHUB_STEP_SUMMARY
          echo "This is a validation-only check for PRs. Jenkins is **not deployed** during this step." >> $GITHUB_STEP_SUMMARY
          echo "Full Jenkins deployment occurs when merged to main branch." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 2: Deploy Jenkins (Runs on push to main only)
  # ============================================================================
  deploy-jenkins:
    name: Deploy Jenkins
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deployment Start
        run: |
          echo "## ðŸš€ Jenkins Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: Full Jenkins deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: Push to main branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - name: Set Terraform Workspace
        id: workspace
        run: |
          # Use dev workspace for now (can be changed to prod later)
          # To use prod: change to 'prod' when ready for production
          echo "workspace=dev" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: |
          WORKSPACE="${{ steps.workspace.outputs.workspace }}"

          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}" \
            -backend-config="key=terraform-states/${WORKSPACE}/infra.tfstate"

          if ! terraform workspace list | grep -q "\b${WORKSPACE}\b"; then
            echo "Creating workspace: ${WORKSPACE}"
            terraform workspace new ${WORKSPACE}
          else
            echo "Selecting workspace: ${WORKSPACE}"
            terraform workspace select ${WORKSPACE}
          fi

          echo "TF_WORKSPACE=${WORKSPACE}" >> $GITHUB_ENV

      - name: Get Jenkins Connection Info
        id: tf_outputs
        working-directory: ./infra/terraform
        run: |
          # Debug: Show current workspace and state
          echo "ðŸ” Current workspace: ${TF_WORKSPACE}"
          echo "ðŸ” Available workspaces:"
          terraform workspace list

          echo ""
          echo "ðŸ” Checking for Terraform outputs..."
          terraform output -json 2>&1 | head -20

          # Check if outputs exist
          if ! terraform output -json 2>&1 | grep -q '"jenkins_public_ip"'; then
            echo ""
            echo "âŒ No Terraform outputs found in workspace: ${TF_WORKSPACE}"
            echo ""
            echo "Possible issues:"
            echo "1. Infrastructure not deployed to this workspace yet"
            echo "2. Terraform Deploy workflow failed"
            echo "3. Wrong workspace selected"
            echo ""
            echo "Current workspace: ${TF_WORKSPACE}"
            echo "Expected outputs: jenkins_public_ip, jenkins_private_ip, jenkins_instance_id"
            exit 1
          fi

          JENKINS_PUBLIC_IP=$(terraform output -raw jenkins_public_ip 2>&1)
          JENKINS_PRIVATE_IP=$(terraform output -raw jenkins_private_ip 2>&1)

          if [[ ! "${JENKINS_PUBLIC_IP}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid public IP: ${JENKINS_PUBLIC_IP}"
            exit 1
          fi

          if [[ ! "${JENKINS_PRIVATE_IP}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid private IP: ${JENKINS_PRIVATE_IP}"
            exit 1
          fi

          echo "jenkins_ip=${JENKINS_PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "jenkins_private_ip=${JENKINS_PRIVATE_IP}" >> $GITHUB_OUTPUT

          echo "ðŸ“ Public IP: ${JENKINS_PUBLIC_IP}"
          echo "ðŸ”’ Private IP: ${JENKINS_PRIVATE_IP}"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Ansible & dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible boto3 botocore

      - name: Configure SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_KEY" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

      - name: Build Ansible Inventory
        run: |
          mkdir -p ansible/inventory
          echo "[jenkins]" > ansible/inventory/hosts.ini
          echo "jenkins_server ansible_host=${{ steps.tf_outputs.outputs.jenkins_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/key.pem" >> ansible/inventory/hosts.ini
          echo "" >> ansible/inventory/hosts.ini
          echo "[jenkins:vars]" >> ansible/inventory/hosts.ini
          echo "ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> ansible/inventory/hosts.ini
          cat ansible/inventory/hosts.ini

      - name: Wait for EC2 Instance to be Ready
        run: |
          echo "â³ Waiting for EC2 instance to be ready..."
          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/key.pem ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} "echo 'SSH connection successful'" 2>/dev/null; then
              echo "âœ… EC2 instance is ready!"
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Waiting 10 seconds..."
            sleep 10
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âŒ EC2 instance did not become ready"
            exit 1
          fi

      - name: Test Ansible Connectivity
        run: |
          echo "ðŸ” Testing Ansible connectivity..."
          ansible -i ansible/inventory/hosts.ini jenkins -m ping -v

      - name: Run Ansible Playbook
        run: |
          echo "ðŸš€ Deploying Jenkins with Ansible..."
          ansible-playbook \
            -i ansible/inventory/hosts.ini \
            ansible/playbooks/deploy_jenkins.yml \
            -v

      - name: Retrieve Jenkins Initial Password
        id: get_password
        run: |
          PASSWORD=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/key.pem ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
            'sudo cat /var/lib/jenkins/secrets/initialAdminPassword' 2>/dev/null || echo "N/A")
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "## âœ… Jenkins Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Access Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Jenkins URL**: http://${{ steps.tf_outputs.outputs.jenkins_ip }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- **Public IP**: ${{ steps.tf_outputs.outputs.jenkins_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Private IP**: ${{ steps.tf_outputs.outputs.jenkins_private_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Initial Admin Password**: \`${{ steps.get_password.outputs.password }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Navigate to the Jenkins URL above" >> $GITHUB_STEP_SUMMARY
          echo "2. Use the Initial Admin Password to log in" >> $GITHUB_STEP_SUMMARY
          echo "3. Complete the Jenkins setup wizard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— SSH Access" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh -i ~/.ssh/key.pem ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Print Jenkins Access Info
        run: |
          echo "======================================"
          echo "ðŸŽ‰ Jenkins Deployment Successful!"
          echo "======================================"
          echo "Jenkins URL: http://${{ steps.tf_outputs.outputs.jenkins_ip }}:8080"
          echo "Initial Admin Password: ${{ steps.get_password.outputs.password }}"
          echo "SSH: ssh -i ~/.ssh/key.pem ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }}"
          echo "======================================"
