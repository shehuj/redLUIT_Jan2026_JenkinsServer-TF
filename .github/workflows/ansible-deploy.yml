name: Ansible Deploy

on:
  workflow_run:
    workflows: ["Terraform Deploy"]
    types:
      - completed
  push:
    branches: [ "main", "dev" ]
    paths:
      - 'ansible/**'          # Only trigger on changes to ansible dir
      - '.github/workflows/ansible-deploy.yml'
  workflow_dispatch:           # Allow manual trigger

permissions:
  contents: read
  id-token: write

jobs:
  deploy-ansible:
    name: Deploy Jenkins with Ansible
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Configure AWS Credentials to access Terraform state
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Setup Terraform to read outputs
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false  # Disable wrapper for clean output

      # Determine workspace based on branch
      - name: Set Terraform Workspace
        id: workspace
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "TF_WORKSPACE=prod" >> $GITHUB_ENV
          else
            echo "TF_WORKSPACE=dev" >> $GITHUB_ENV
          fi

      # Initialize Terraform to access state
      - name: Terraform Init
        working-directory: ./infra/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}" \
            -backend-config="key=terraform-states/${TF_WORKSPACE}/infra.tfstate"

          terraform workspace select ${TF_WORKSPACE} || terraform workspace new ${TF_WORKSPACE}

      # Get Jenkins IP from Terraform outputs
      - name: Get Jenkins IP from Terraform
        id: tf_outputs
        working-directory: ./infra/terraform
        run: |
          JENKINS_IP=$(terraform output -raw jenkins_public_ip)
          echo "jenkins_ip=${JENKINS_IP}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Retrieved Jenkins IP: ${JENKINS_IP}"

      # Install Python and dependencies for Ansible
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Ansible & dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible boto3 botocore

      # Prepare SSH key for connecting to your EC2 instance
      - name: Configure SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_KEY" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

      # Create dynamic inventory file from Terraform output
      - name: Build Ansible Inventory
        id: inventory
        run: |
          mkdir -p ansible/inventory
          echo "[jenkins]" > ansible/inventory/hosts.ini
          echo "jenkins_server ansible_host=${{ steps.tf_outputs.outputs.jenkins_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/key.pem" >> ansible/inventory/hosts.ini
          echo "" >> ansible/inventory/hosts.ini
          echo "[jenkins:vars]" >> ansible/inventory/hosts.ini
          echo "ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> ansible/inventory/hosts.ini
          cat ansible/inventory/hosts.ini

      # Validate connectivity before running the playbook
      - name: Test Ansible Connectivity
        run: |
          ansible -i ansible/inventory/hosts.ini jenkins -m ping

      # Run the Ansible Playbook
      - name: Run Ansible Playbook
        run: |
          ansible-playbook \
            -i ansible/inventory/hosts.ini \
            ansible/playbooks/deploy_jenkins.yml \
            -v

      # Output Jenkins initial admin password
      - name: Retrieve Jenkins Initial Password
        id: get_password
        run: |
          PASSWORD=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/key.pem ubuntu@${{ steps.tf_outputs.outputs.jenkins_ip }} \
            'sudo cat /var/lib/jenkins/secrets/initialAdminPassword')
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      # ðŸ“Š Display Summary
      - name: Deployment Summary
        run: |
          echo "## âœ… Jenkins Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Access Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Jenkins URL**: http://${{ steps.tf_outputs.outputs.jenkins_ip }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- **Initial Admin Password**: \`${{ steps.get_password.outputs.password }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Navigate to the Jenkins URL above" >> $GITHUB_STEP_SUMMARY
          echo "2. Use the Initial Admin Password to log in" >> $GITHUB_STEP_SUMMARY
          echo "3. Complete the Jenkins setup wizard" >> $GITHUB_STEP_SUMMARY

      - name: Print Jenkins Access
        run: |
          echo "======================================"
          echo "ðŸŽ‰ Jenkins Deployment Successful!"
          echo "======================================"
          echo "Jenkins URL: http://${{ steps.tf_outputs.outputs.jenkins_ip }}:8080"
          echo "Initial Admin Password: ${{ steps.get_password.outputs.password }}"
          echo "======================================"