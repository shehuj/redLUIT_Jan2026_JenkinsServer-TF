name: Destroy JenkinsProject Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DESTROY" to confirm resource deletion'
        required: true
        type: string
      reason:
        description: 'Reason for destroying infrastructure'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  validate-input:
    name: 'Validate Confirmation'
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}

    steps:
      - name: Validate Destroy Confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ Invalid confirmation. You must type exactly 'DESTROY' to proceed."
            echo "You entered: ${{ github.event.inputs.confirmation }}"
            exit 1
          fi
          echo "âœ… Confirmation validated"
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: Log Destruction Request
        run: |
          echo "## ðŸš¨ DESTRUCTION REQUEST LOGGED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** JenkinsProject" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Proceeding with infrastructure destruction..." >> $GITHUB_STEP_SUMMARY

  pre-destroy-inventory:
    name: 'Pre-Destroy Inventory'
    runs-on: ubuntu-latest
    needs: validate-input

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./jenkinsProject/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}"

      - name: Show Current Resources
        working-directory: ./jenkinsProject/terraform
        run: |
          echo "## ðŸ“‹ Current Terraform State Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to view resources</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          terraform show -no-color 2>&1 | head -200 >> $GITHUB_STEP_SUMMARY || echo "No state found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: 'Destroy Infrastructure'
    runs-on: ubuntu-latest
    needs: [validate-input, pre-destroy-inventory]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./jenkinsProject/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}"

      - name: Empty S3 Bucket First
        working-directory: ./jenkinsProject/terraform
        run: |
          # Get bucket name from Terraform
          BUCKET_NAME=$(terraform output -raw jenkins_artifacts_bucket_name 2>/dev/null || echo "")

          if [ ! -z "$BUCKET_NAME" ]; then
            echo "ðŸª£ Emptying S3 bucket: $BUCKET_NAME"

            # Delete all object versions
            aws s3api list-object-versions \
              --bucket "$BUCKET_NAME" \
              --query 'Versions[].{Key:Key,VersionId:VersionId}' \
              --output text | while read key version; do
                if [ ! -z "$key" ]; then
                  echo "Deleting version: $key ($version)"
                  aws s3api delete-object --bucket "$BUCKET_NAME" --key "$key" --version-id "$version" || true
                fi
            done

            # Delete all delete markers
            aws s3api list-object-versions \
              --bucket "$BUCKET_NAME" \
              --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' \
              --output text | while read key version; do
                if [ ! -z "$key" ]; then
                  echo "Deleting marker: $key ($version)"
                  aws s3api delete-object --bucket "$BUCKET_NAME" --key "$key" --version-id "$version" || true
                fi
            done

            echo "âœ… S3 bucket emptied"
          else
            echo "âš ï¸  No S3 bucket found in outputs"
          fi

      - name: Terraform Destroy
        working-directory: ./jenkinsProject/terraform
        run: |
          echo "Starting Terraform destroy for jenkinsProject..."
          terraform destroy -auto-approve

      - name: Verify Destruction
        run: |
          echo "## ðŸ” Post-Destroy Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for remaining EC2 instances
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=JenkinsProject" "Name=instance-state-name,Values=running,stopped,stopping,pending" \
            --query 'Reservations[*].Instances[*].InstanceId' \
            --output text)

          if [ -z "$INSTANCES" ]; then
            echo "âœ… No EC2 instances remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Found remaining instances: $INSTANCES" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for remaining security groups
          SGS=$(aws ec2 describe-security-groups \
            --filters "Name=tag:Project,Values=JenkinsProject" \
            --query 'SecurityGroups[*].GroupId' \
            --output text)

          if [ -z "$SGS" ]; then
            echo "âœ… No security groups remaining" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Found remaining security groups: $SGS" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… JenkinsProject Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
