name: Terraform Apply - jenkinsProject

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'jenkinsProject/terraform/**'
      - '.github/workflows/jenkinsProject-tf.yml'

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: "1.5.0"
        terraform_wrapper: false

    - name: Terraform Init
      run: |
        cd ./jenkinsProject/terraform
        terraform init -reconfigure \
          -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
          -backend-config="region=${{ secrets.AWS_REGION }}" \
          -backend-config="dynamodb_table=${{ secrets.TF_DYNAMODB_TABLE }}"

    - name: Terraform Validate
      run: |
        cd ./jenkinsProject/terraform
        terraform validate

    - name: Terraform Plan
      run: |
        cd ./jenkinsProject/terraform
        terraform plan -out=tfplan

    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: jenkinsProject-plan-${{ github.sha }}
        path: jenkinsProject/terraform/tfplan
        retention-days: 7

    - name: Terraform Apply
      run: |
        cd ./jenkinsProject/terraform
        terraform apply -auto-approve tfplan

    - name: Capture Terraform Outputs
      id: tf_outputs
      run: |
        cd ./jenkinsProject/terraform

        # Capture outputs without debug noise
        JENKINS_PUBLIC_IP=$(terraform output -raw jenkins_public_ip 2>/dev/null || echo "")
        JENKINS_PRIVATE_IP=$(terraform output -raw jenkins_private_ip 2>/dev/null || echo "")
        JENKINS_INSTANCE_ID=$(terraform output -raw jenkins_instance_id 2>/dev/null || echo "")
        ARTIFACTS_BUCKET=$(terraform output -raw jenkins_artifacts_bucket_name 2>/dev/null || echo "")

        # Validate outputs
        if [[ -z "${JENKINS_PUBLIC_IP}" ]] || [[ -z "${JENKINS_INSTANCE_ID}" ]]; then
          echo "âŒ Error: Failed to retrieve Terraform outputs"
          echo "Public IP: '${JENKINS_PUBLIC_IP}'"
          echo "Private IP: '${JENKINS_PRIVATE_IP}'"
          echo "Instance ID: '${JENKINS_INSTANCE_ID}'"
          echo "Artifacts Bucket: '${ARTIFACTS_BUCKET}'"
          terraform output
          exit 1
        fi

        # Validate IP formats
        if [[ ! "${JENKINS_PUBLIC_IP}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Error: Invalid public IP format: '${JENKINS_PUBLIC_IP}'"
          exit 1
        fi

        if [[ ! "${JENKINS_PRIVATE_IP}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Error: Invalid private IP format: '${JENKINS_PRIVATE_IP}'"
          exit 1
        fi

        # Export to outputs
        echo "jenkins_public_ip=${JENKINS_PUBLIC_IP}" >> $GITHUB_OUTPUT
        echo "jenkins_private_ip=${JENKINS_PRIVATE_IP}" >> $GITHUB_OUTPUT
        echo "jenkins_instance_id=${JENKINS_INSTANCE_ID}" >> $GITHUB_OUTPUT
        echo "artifacts_bucket=${ARTIFACTS_BUCKET}" >> $GITHUB_OUTPUT

        echo "ðŸ“ Jenkins Public IP: ${JENKINS_PUBLIC_IP}"
        echo "ðŸ”’ Jenkins Private IP: ${JENKINS_PRIVATE_IP}"
        echo "ðŸ†” Jenkins Instance ID: ${JENKINS_INSTANCE_ID}"
        echo "ðŸª£ Artifacts Bucket: ${ARTIFACTS_BUCKET}"

    - name: Save Jenkins Connection Info
      run: |
        mkdir -p outputs
        echo "${{ steps.tf_outputs.outputs.jenkins_public_ip }}" > outputs/jenkins_public_ip.txt
        echo "${{ steps.tf_outputs.outputs.jenkins_private_ip }}" > outputs/jenkins_private_ip.txt
        echo "${{ steps.tf_outputs.outputs.jenkins_instance_id }}" > outputs/jenkins_instance_id.txt
        echo "${{ steps.tf_outputs.outputs.artifacts_bucket }}" > outputs/jenkins_artifacts_bucket.txt

    - name: Upload Terraform Outputs
      uses: actions/upload-artifact@v4
      with:
        name: jenkinsProject-outputs-${{ github.sha }}
        path: outputs/
        retention-days: 7

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ JenkinsProject Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Public IP**: ${{ steps.tf_outputs.outputs.jenkins_public_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Private IP**: ${{ steps.tf_outputs.outputs.jenkins_private_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Instance ID**: ${{ steps.tf_outputs.outputs.jenkins_instance_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifacts Bucket**: \`${{ steps.tf_outputs.outputs.artifacts_bucket }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Access Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Jenkins URL**: http://${{ steps.tf_outputs.outputs.jenkins_public_ip }}:8080" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Server Access" >> $GITHUB_STEP_SUMMARY
        echo "**Via AWS Systems Manager (Recommended - No SSH port needed):**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "aws ssm start-session --target ${{ steps.tf_outputs.outputs.jenkins_instance_id }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Via SSH:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "ssh -i ~/.ssh/key.pem ubuntu@${{ steps.tf_outputs.outputs.jenkins_public_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸª£ S3 Artifacts Bucket" >> $GITHUB_STEP_SUMMARY
        echo "- **Bucket Name**: \`${{ steps.tf_outputs.outputs.artifacts_bucket }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Access**: Private (blocked from public access)" >> $GITHUB_STEP_SUMMARY
        echo "- **Encryption**: AES256 server-side encryption enabled" >> $GITHUB_STEP_SUMMARY
        echo "- **Versioning**: Enabled" >> $GITHUB_STEP_SUMMARY
        echo "- **Lifecycle**: Artifacts deleted after 180 days, old versions after 90 days" >> $GITHUB_STEP_SUMMARY
        echo "- **IAM Role**: Jenkins EC2 instance has read/write access via IAM instance profile" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Merge this PR to main to trigger Ansible configuration" >> $GITHUB_STEP_SUMMARY
        echo "2. Jenkins will be automatically configured via Ansible" >> $GITHUB_STEP_SUMMARY
        echo "3. Access Jenkins at the URL above after configuration completes" >> $GITHUB_STEP_SUMMARY
        echo "4. Configure Jenkins to use S3 bucket \`${{ steps.tf_outputs.outputs.artifacts_bucket }}\` for artifact storage" >> $GITHUB_STEP_SUMMARY